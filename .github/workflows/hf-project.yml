name: Huggingface Project Build (Multi-Project)

on:
  workflow_dispatch:
    inputs:
      project_dir:
        description: 'Project directory name (relative to the cloned repository root)'
        required: true
        default: 'huggingface'
      projects:
        description: 'uptime,cli-proxy-api,new-api,openclaw,dbgate'
        required: false
        type: string
        default: 'cli-proxy-api,new-api,openclaw,dbgate,open-webui'
      image_tag:
        description: 'Docker image tag'
        required: true
        default: 'latest'
      push_to_dockerhub:
        description: 'Push to DockerHub'
        type: boolean
        default: false
      push_to_ghcr:
        description: 'Push to GHCR'
        type: boolean
        default: true
      build_platforms:
        description: 'Select build platforms'
        required: true
        type: choice
        default: 'linux/amd64,linux/arm64'
        options:
          - 'linux/amd64'
          - 'linux/arm64'
          - 'linux/amd64,linux/arm64'
          - 'linux/amd64,linux/arm64,linux/arm/v7'
  schedule:
    - cron: '0 20 * * *'  # 每天凌晨 0 点运行

permissions:
  packages: write
  contents: read

env:
  DEFAULT_PROJECT_DIR: 'huggingface'
  DEFAULT_PROJECTS: 'cli-proxy-api,new-api,openclaw,dbgate,open-webui'
  DEFAULT_IMAGE_TAG: 'latest'
  DEFAULT_PUSH_TO_DOCKERHUB: 'false'
  DEFAULT_PUSH_TO_GHCR: 'true'
  DEFAULT_BUILD_PLATFORMS: 'linux/amd64,linux/arm64'

jobs:
  # 预处理任务：解析多选项目并构建矩阵
  setup:
    runs-on: ubuntu-latest
    outputs:
      project_matrix: ${{ steps.set-matrix.outputs.matrix }}
      project_dir: ${{ steps.set-outputs.outputs.project_dir }}
      image_tag: ${{ steps.set-outputs.outputs.image_tag }}
      push_to_dockerhub: ${{ steps.set-outputs.outputs.push_to_dockerhub }}
      push_to_ghcr: ${{ steps.set-outputs.outputs.push_to_ghcr }}
      build_platforms: ${{ steps.set-outputs.outputs.build_platforms }}
    steps:
      - id: set-outputs
        run: |
          # 设置默认值
          PROJECT_DIR="${{ github.event.inputs.project_dir }}"
          IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          PUSH_TO_DOCKERHUB="${{ github.event.inputs.push_to_dockerhub }}"
          PUSH_TO_GHCR="${{ github.event.inputs.push_to_ghcr }}"
          BUILD_PLATFORMS="${{ github.event.inputs.build_platforms }}"

          # 如果为空，使用默认值
          [ -z "$PROJECT_DIR" ] && PROJECT_DIR="${{ env.DEFAULT_PROJECT_DIR }}"
          [ -z "$IMAGE_TAG" ] && IMAGE_TAG="${{ env.DEFAULT_IMAGE_TAG }}"
          [ -z "$PUSH_TO_DOCKERHUB" ] && PUSH_TO_DOCKERHUB="${{ env.DEFAULT_PUSH_TO_DOCKERHUB }}"
          [ -z "$PUSH_TO_GHCR" ] && PUSH_TO_GHCR="${{ env.DEFAULT_PUSH_TO_GHCR }}"
          [ -z "$BUILD_PLATFORMS" ] && BUILD_PLATFORMS="${{ env.DEFAULT_BUILD_PLATFORMS }}"

          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "push_to_dockerhub=$PUSH_TO_DOCKERHUB" >> $GITHUB_OUTPUT
          echo "push_to_ghcr=$PUSH_TO_GHCR" >> $GITHUB_OUTPUT
          echo "build_platforms=$BUILD_PLATFORMS" >> $GITHUB_OUTPUT

      - id: set-matrix
        run: |
          INPUT_PROJECTS="${{ github.event.inputs.projects }}"
          # 如果为空，使用默认值
          [ -z "$INPUT_PROJECTS" ] && INPUT_PROJECTS="${{ env.DEFAULT_PROJECTS }}"

          # 处理项目列表，分割为数组
          PROJECTS=$(echo "$INPUT_PROJECTS" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | jq -R . | jq -s -c .)
          echo "Projects to build: $PROJECTS"

          # 构建矩阵
          MATRIX=$(jq -n --argjson projects "$PROJECTS" \
            '[$projects[] | {project_type: ., custom_name: ""}]' -c)

          echo "Matrix: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  build:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.setup.outputs.project_matrix) }}

    env:
      PROJECT_DIR: ${{ needs.setup.outputs.project_dir }}
      PROJECT_TYPE: ${{ matrix.project_type }}
      CUSTOM_NAME: ${{ matrix.custom_name }}
      IMAGE_TAG: ${{ needs.setup.outputs.image_tag }}
      REPO_URL: ${{ vars.REPO_URL }}
      REPO_PATH: ${{ vars.REPO_PATH }}
      PUSH_TO_DOCKERHUB: ${{ needs.setup.outputs.push_to_dockerhub }}
      PUSH_TO_GHCR: ${{ needs.setup.outputs.push_to_ghcr }}
      BUILD_PLATFORMS: ${{ needs.setup.outputs.build_platforms }}

    steps:
      # 拉取私有仓库代码（使用 GitHub PAT）
      - name: Pull project code
        env:
          REPO_ACCESS_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        run: |
          git clone https://${{ env.REPO_ACCESS_TOKEN }}@${{ env.REPO_URL}} ${{ env.REPO_PATH }}

      # 设置 Docker 构建环境
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      # 登录 DockerHub（仅在需要时）
      - name: Login to DockerHub
        if: env.PUSH_TO_DOCKERHUB == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 登录 GHCR（仅在需要时）
      - name: Login to GHCR
        if: env.PUSH_TO_GHCR == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 设置镜像名称和 Dockerfile（基于项目类型和自定义名称）
      - name: Set image name and Dockerfile based on project type
        run: |
          PROJECT_TYPE="${{ env.PROJECT_TYPE }}"
          CUSTOM_NAME="${{ env.CUSTOM_NAME }}"
          
          if [ -n "$CUSTOM_NAME" ]; then
            PROJECT_NAME="$CUSTOM_NAME"
            echo "Using custom name: $PROJECT_NAME"
          else
            PROJECT_NAME="$PROJECT_TYPE"
            echo "Using project type: $PROJECT_NAME"
          fi
          
          echo "IMAGE_NAME=smanx/${PROJECT_NAME}-hf" >> $GITHUB_ENV
          echo "DOCKERFILE=Dockerfile-${PROJECT_NAME}" >> $GITHUB_ENV

      # 检查 Dockerfile 是否存在
      - name: Check Dockerfile exists
        run: |
          cd ${{ env.REPO_PATH }}/${{ env.PROJECT_DIR }}
          if [ ! -f "${{ env.DOCKERFILE }}" ]; then
            echo "Error: Dockerfile ${{ env.DOCKERFILE }} does not exist in the project directory."
            exit 1
          fi
          echo "Using Dockerfile: ${{ env.DOCKERFILE }}"

      # 构建 Docker 镜像（支持多平台）并推送到指定注册表
      - name: Build and push Docker image with tags
        run: |
          cd ${{ env.REPO_PATH }}/${{ env.PROJECT_DIR }}
          BUILD_TAGS=""

          # 根据选择添加标签
          if [ "${{ env.PUSH_TO_DOCKERHUB }}" = "true" ]; then
            BUILD_TAGS="$BUILD_TAGS -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          fi

          if [ "${{ env.PUSH_TO_GHCR }}" = "true" ]; then
            BUILD_TAGS="$BUILD_TAGS -t ghcr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          fi

          # 如果至少选择了一个注册表，则构建和推送
          if [ -n "$BUILD_TAGS" ]; then
            docker buildx build \
              --platform ${{ env.BUILD_PLATFORMS }} \
              --file ${{ env.DOCKERFILE }} \
              $BUILD_TAGS \
              . --push
          else
            echo "No registry selected for push. Building image only."
            docker buildx build \
              --platform ${{ env.BUILD_PLATFORMS }} \
              --file ${{ env.DOCKERFILE }} \
              .
          fi

      # 输出构建信息
      - name: Output build information
        run: |
          echo "Build completed for project: ${{ matrix.project_type }}"
          echo "Project directory: ${{ env.PROJECT_DIR }}"
          echo "Dockerfile: ${{ env.DOCKERFILE }}"
          echo "Image name: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          echo "Push to DockerHub: ${{ env.PUSH_TO_DOCKERHUB }}"
          echo "Push to GHCR: ${{ env.PUSH_TO_GHCR }}"
          echo "Build platforms: ${{ env.BUILD_PLATFORMS }}"
          
