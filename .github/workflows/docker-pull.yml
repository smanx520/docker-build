name: Docker Multi Pull

on:
  workflow_dispatch:
    inputs:
      docker_images:
        description: 'Docker镜像列表(逗号分隔)'
        required: false
        default: 'node,python'
  schedule:
    - cron: '0 */6 * * *'  # 每6小时运行一次

jobs:
  pull-images:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-13]
      fail-fast: false

    runs-on: ${{ matrix.os }}

    steps:
      - name: Pull Docker Images
        shell: bash
        run: |
          # 设置默认值（schedule 触发时 inputs 为空）
          DOCKER_IMAGES="${{ inputs.docker_images }}"

          # 设置默认值
          [ -z "$DOCKER_IMAGES" ] && DOCKER_IMAGES="${{ vars.DOCKER_IMAGES_PULL }}"

          # 将逗号分隔的镜像列表转换为换行分隔
          echo "$DOCKER_IMAGES" | tr ',' '\n' | tr -d '\r' > images.txt

          # 统计镜像数量
          image_count=$(wc -l < images.txt)
          interval=360  # 6分钟 = 360秒，确保1小时运行10次
          max_runtime=18000  # 5小时 = 18000秒

          echo "镜像列表: $DOCKER_IMAGES"
          echo "镜像数量: $image_count"
          echo "调用间隔: ${interval}秒 (6分钟)，即每小时10次"
          echo "最大运行时长: ${max_runtime}秒 (5小时)"

          # 记录开始时间
          start_time=$(date +%s)

          inspect_count=0
          round=1
          while true; do
            # 检查运行时长
            current_time=$(date +%s)
            elapsed=$((current_time - start_time))
            if [ $elapsed -ge $max_runtime ]; then
              echo "已运行超过 5 小时，退出"
              exit 0
            fi

            echo "=== 第 $round 轮 ==="

            # 读取文件并处理每一行
            while IFS= read -r image_name || [ -n "$image_name" ]; do
              if [ -z "$image_name" ]; then
                continue
              fi

              inspect_count=$((inspect_count + 1))
              echo "[$inspect_count] Inspecting: $image_name"
              docker manifest inspect "$image_name"

              # 每次调用后休眠 6 分钟（确保1小时运行10次）
              echo "休眠 ${interval} 秒后继续..."
              sleep $interval
            done < images.txt

            round=$((round + 1))
          done