name: Docker Multi Pull

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 */6 * * *'  # 每6小时运行一次

jobs:
  pull-images:
    runs-on: ubuntu-latest

    steps:
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull Docker Images
        run: |
          # 将变量内容保存到文件中并确保使用 Unix 格式的换行符
          echo "${{ vars.DOCKER_IMAGES }}" | tr -d '\r' > images.txt

          # 记录开始时间
          start_time=$(date +%s)
          timeout=3600  # 1小时超时

          round=1
          while true; do
            current_time=$(date +%s)
            elapsed=$((current_time - start_time))

            # 检查是否超过1小时
            if [ $elapsed -ge $timeout ]; then
              echo "已运行1小时，强制退出"
              exit 0
            fi

            echo "=== 第 $round 轮拉取 ==="
            echo "已运行时间: $elapsed 秒"

            # 读取文件并处理每一行
            while IFS=' ' read -r image_name pull_count || [ -n "$image_name" ]; do
              if [ -z "$image_name" ]; then
                continue
              fi

              echo "Pulling: $image_name"
              docker pull "$image_name"

              # 检查时间
              current_time=$(date +%s)
              elapsed=$((current_time - start_time))
              if [ $elapsed -ge $timeout ]; then
                echo "已运行1小时，强制退出"
                exit 0
              fi
            done < images.txt

            # 休眠随机时长
            sleeptime=${{ vars.PULLSLEEPTIME }}
            random_sleep=$((RANDOM % (sleeptime + 1)))
            echo "随机休眠 $random_sleep 秒后开始下一轮..."
            sleep $random_sleep

            round=$((round + 1))
          done 
