name: Docker Multi Pull

on:
  workflow_dispatch:
    inputs:
      docker_images:
        description: 'Docker镜像列表(逗号分隔)'
        required: true
        default: 'smanx/docker-qq,smanx/docker-wechat,smanx/docker-v2rayn,smanx/docker-coremark,smanx/openclaw,smanx/nanobot'
      pull_sleep_time:
        description: '休眠基准时间(秒)'
        required: true
        default: '60'
      timeout_hours:
        description: '运行时长(小时)'
        required: true
        default: '5'
  schedule:
    - cron: '0 */6 * * *'  # 每6小时运行一次

jobs:
  pull-images:
    runs-on: ubuntu-latest

    steps:
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull Docker Images
        run: |
          # 设置默认值（schedule 触发时 inputs 为���）
          DOCKER_IMAGES="${{ inputs.docker_images }}"
          PULL_SLEEP_TIME="${{ inputs.pull_sleep_time }}"
          TIMEOUT_HOURS="${{ inputs.timeout_hours }}"

          # 设置默认值
          # [ -z "$DOCKER_IMAGES" ] && DOCKER_IMAGES="smanx/docker-qq,smanx/docker-wechat,smanx/docker-v2rayn,smanx/docker-coremark,smanx/openclaw,smanx/nanobot"
          # [ -z "$PULL_SLEEP_TIME" ] && PULL_SLEEP_TIME=60
          # [ -z "$TIMEOUT_HOURS" ] && TIMEOUT_HOURS=1

          # 支持小数值，转换为秒（使用 bc 进行浮点运算）
          timeout=$(echo "$TIMEOUT_HOURS * 3600" | bc | cut -d. -f1)

          # 将逗号分隔的镜像列表转换为换行分隔
          echo "$DOCKER_IMAGES" | tr ',' '\n' | tr -d '\r' > images.txt

          # 记录开始时间
          start_time=$(date +%s)

          round=1
          while true; do
            current_time=$(date +%s)
            elapsed=$((current_time - start_time))

            # 检查是否超时
            if [ "$elapsed" -ge "$timeout" ]; then
              echo "已运行${TIMEOUT_HOURS}小时，强制退出"
              exit 0
            fi

            echo "=== 第 $round 轮拉取 ==="
            # 计算百分比
            percent=$((elapsed * 100 / timeout))
            echo "已运行时间: $elapsed 秒 / $timeout 秒 ($percent%)"

            # 读取文件并处理每一行
            while IFS= read -r image_name || [ -n "$image_name" ]; do
              if [ -z "$image_name" ]; then
                continue
              fi

              echo "Pulling: $image_name"
              docker pull "$image_name"

              # 检查时间
              current_time=$(date +%s)
              elapsed=$((current_time - start_time))
              if [ "$elapsed" -ge "$timeout" ]; then
                echo "已运行${TIMEOUT_HOURS}小时，强制退出"
                exit 0
              fi
            done < images.txt

            # 休眠随机时长 (PULLSLEEPTIME/2 到 PULLSLEEPTIME*1.5)
            min_sleep=$(echo "$PULL_SLEEP_TIME / 2" | bc | cut -d. -f1)
            max_sleep=$(echo "$PULL_SLEEP_TIME * 1.5" | bc | cut -d. -f1)
            random_sleep=$((min_sleep + RANDOM % (max_sleep - min_sleep + 1)))
            # 计算当前进度
            current_time=$(date +%s)
            elapsed=$((current_time - start_time))
            percent=$((elapsed * 100 / timeout))
            echo "已运行时间: $elapsed 秒 / $timeout 秒 ($percent%)，随机休眠 $random_sleep 秒后开始下一轮..."
            sleep $random_sleep

            round=$((round + 1))
          done 
